/* ============================================================
   â–¼ 1. è·æ¥­ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆ16ãƒ“ãƒ«ãƒ‰ Ã— ğŸ‘ãŠã™ã™ã‚ã‚³ã‚¢ï¼‰
   ============================================================ */

const jobPresets = {
  "ãƒ“ãƒ¼ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼": {
    builds: {
      "ç‹‚éŸ³å‹": [
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦",
        "é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»HPå‡ç¸®","æ¥µãƒ»å¿œæ€¥å‡¦ç½®","æ¥µãƒ»å¹¸é‹ä¼šå¿ƒ",
        "ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ",
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","é›†ä¸­ãƒ»è© å”±"
      ],
      "éŸ¿å¥å‹": [
        "ç‰¹æ”»å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»ä¼šå¿ƒ","æ¥µãƒ»å¹¸é‹ä¼šå¿ƒ","çŸ¥åŠ›å¼·åŒ–","é­”æ³•è€æ€§",
        "ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","æ¥µãƒ»HPå‡ç¸®","ç­‹åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–",
        "ç‰©ç†è€æ€§","é›†ä¸­ãƒ»è© å”±","æ¥µãƒ»å¿œæ€¥å‡¦ç½®","æ•æ·å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ",
        "é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ]
    }
  },

  "ã‚·ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼": {
    builds: {
      "å…‰ç •å‹": [
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","æ¥µãƒ»HPå‡ç¸®","æ¥µãƒ»çµ¶å¢ƒå®ˆè­·","æ¥µãƒ»HPå¸å",
        "æ¥µãƒ»HPå¤‰å‹•","ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–",
        "ç²¾é‹­æ‰“æ’ƒ","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»è© å”±",
        "é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ],
      "å…‰ç›¾å‹": [
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","æ¥µãƒ»HPå‡ç¸®","æ¥µãƒ»çµ¶å¢ƒå®ˆè­·","æ¥µãƒ»HPå¤‰å‹•",
        "æ¥µãƒ»HPå¸å","ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–",
        "ç²¾é‹­æ‰“æ’ƒ","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»è© å”±",
        "é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ]
    }
  },

  "ãƒ‡ã‚£ãƒã‚¤ãƒ³ã‚¢ãƒ¼ãƒãƒ£ãƒ¼": {
    builds: {
      "ç‹¼å¼“å‹": [
        "æ•æ·å¼·åŒ–","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","ç­‹åŠ›å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é›†ä¸­ãƒ»è© å”±","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","çŸ¥åŠ›å¼·åŒ–",
        "é­”æ³•è€æ€§","é›†ä¸­ãƒ»ä¼šå¿ƒ","ç²¾é‹­æ‰“æ’ƒ","æ¥µãƒ»é©å¿œåŠ›",
        "ç‰¹æ”»å›å¾©å¼·åŒ–","ç‰©ç†è€æ€§","é›†ä¸­ãƒ»å¹¸é‹"
      ],
      "é·¹å¼“å‹": [
        "æ•æ·å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦",
        "é›†ä¸­ãƒ»ä¼šå¿ƒ","é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ¥µãƒ»é©å¿œåŠ›",
        "ç­‹åŠ›å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","é›†ä¸­ãƒ»è© å”±"
      ]
    }
  },

  "ãƒ˜ãƒ´ã‚£ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³": {
    builds: {
      "å‰›èº«å‹": [
        "é­”æ³•è€æ€§","ç­‹åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é›†ä¸­ãƒ»ä¼šå¿ƒ","ç‰©ç†è€æ€§","æ•æ·å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»è© å”±",
        "é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»çµ¶å¢ƒå®ˆè­·","çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–",
        "é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·"
      ],
      "å‰›å®ˆå‹": [
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","æ¥µãƒ»çµ¶å¢ƒå®ˆè­·","ç­‹åŠ›å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–",
        "ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é›†ä¸­ãƒ»å¹¸é‹","æ•æ·å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»è© å”±",
        "é›†ä¸­ãƒ»ä¼šå¿ƒ","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ]
    }
  },

  "ãƒ´ã‚¡ãƒ¼ãƒ€ãƒ³ãƒˆã‚ªãƒ©ã‚¯ãƒ«": {
    builds: {
      "å¨å’²å‹": [
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»å¹¸é‹",
        "æ¥µãƒ»HPå‡ç¸®","æ¥µãƒ»å¿œæ€¥å‡¦ç½®","æ¥µãƒ»å¹¸é‹ä¼šå¿ƒ","ç­‹åŠ›å¼·åŒ–",
        "æ•æ·å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é­”æ³•è€æ€§",
        "ç‰©ç†è€æ€§","é›†ä¸­ãƒ»è© å”±","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ],
      "æ£®ç™’å‹": [
        "ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»è© å”±","æ¥µãƒ»HPå‡ç¸®",
        "æ¥µãƒ»å¿œæ€¥å‡¦ç½®","æ¥µãƒ»å¹¸é‹ä¼šå¿ƒ","ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–",
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é­”æ³•è€æ€§",
        "ç‰©ç†è€æ€§","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","é›†ä¸­ãƒ»ä¼šå¿ƒ"
      ]
    }
  },

  "ã‚²ã‚¤ãƒ«ãƒ©ãƒ³ã‚µãƒ¼": {
    builds: {
      "çƒˆé¢¨å‹": [
        "ç­‹åŠ›å¼·åŒ–","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","æ¥µãƒ»HPå¤‰å‹•","ç‰¹æ”»å›å¾©å¼·åŒ–",
        "ç‰©ç†è€æ€§","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ•æ·å¼·åŒ–",
        "ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","æ¥µãƒ»é©å¿œåŠ›","çŸ¥åŠ›å¼·åŒ–",
        "é­”æ³•è€æ€§","é›†ä¸­ãƒ»è© å”±","é›†ä¸­ãƒ»ä¼šå¿ƒ"
      ],
      "ä¹±é¢¨å‹": [
        "ç­‹åŠ›å¼·åŒ–","é›†ä¸­ãƒ»ä¼šå¿ƒ","æ¥µãƒ»é©å¿œåŠ›","çŸ¥åŠ›å¼·åŒ–","é­”æ³•è€æ€§",
        "ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»HPå¤‰å‹•","ç‰¹æ”»å›å¾©å¼·åŒ–",
        "ç²¾é‹­æ‰“æ’ƒ","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ•æ·å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é›†ä¸­ãƒ»è© å”±"
      ]
    }
  },

  "ãƒ•ãƒ­ã‚¹ãƒˆãƒ¡ã‚¤ã‚¸": {
    builds: {
      "æ°·ç‰™å‹": [
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»è© å”±",
        "é›†ä¸­ãƒ»ä¼šå¿ƒ","é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ¥µãƒ»é©å¿œåŠ›",
        "ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ],
      "éœœå¤©å‹": [
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»è© å”±",
        "æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ¥µãƒ»é©å¿œåŠ›","ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–",
        "ç‰¹åŒºå›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é­”æ³•è€æ€§","ç‰©ç†è€æ€§",
        "é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","é›†ä¸­ãƒ»ä¼šå¿ƒ","é›†ä¸­ãƒ»å¹¸é‹"
      ]
    }
  },

  "ã‚¹ãƒˆãƒ¼ãƒ ãƒ–ãƒ¬ã‚¤ãƒ‰": {
    builds: {
      "é›·åˆƒå‹": [
        "æ•æ·å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»ä¼šå¿ƒ",
        "æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ¥µãƒ»é©å¿œåŠ›","æ¥µãƒ»HPå¤‰å‹•","ç­‹åŠ›å¼·åŒ–",
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é­”æ³•è€æ€§",
        "ç‰©ç†è€æ€§","é›†ä¸­ãƒ»è© å”±","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ],
      "æœˆå½±å‹": [
        "æ•æ·å¼·åŒ–","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","æ¥µãƒ»é©å¿œåŠ›","çŸ¥åŠ›å¼·åŒ–",
        "é­”æ³•è€æ€§","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»HPå¤‰å‹•",
        "ç‰¹æ”»å›å¾©å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","ç­‹åŠ›å¼·åŒ–",
        "ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»è© å”±"
      ]
    }
  }
};


/* ============================================================
   â–¼ 2. UI åˆæœŸåŒ–
   ============================================================ */

window.onload = () => {
  const jobSelect = document.getElementById("jobSelect");
  jobSelect.innerHTML = Object.keys(jobPresets)
    .map(j => `<option value="${j}">${j}</option>`)
    .join("");

  onJobChange();
};


/* ============================================================
   â–¼ 3. è·æ¥­å¤‰æ›´ â†’ ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—æ›´æ–°
   ============================================================ */

function onJobChange() {
  const job = document.getElementById("jobSelect").value;
  const buildSelect = document.getElementById("buildSelect");

  const builds = Object.keys(jobPresets[job].builds);
  buildSelect.innerHTML = builds.map(b => `<option value="${b}">${b}</option>`).join("");

  onBuildChange();
}


/* ============================================================
   â–¼ 4. ãƒ“ãƒ«ãƒ‰å¤‰æ›´ â†’ ãŠã™ã™ã‚ã‚³ã‚¢è¡¨ç¤º
   ============================================================ */

function onBuildChange() {
  const job = document.getElementById("jobSelect").value;
  const build = document.getElementById("buildSelect").value;

  const list = jobPresets[job].builds[build];

  document.getElementById("recommendedList").innerHTML =
    list.map(x => `ãƒ»${x}`).join("<br>");

  renderResults();
}


/* ============================================================
   â–¼ 5. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²
   ============================================================ */

let modules = [];
let moduleId = 0;

function addModule() {
  if (modules.length >= 300) {
    alert("ç™»éŒ²ã¯300å€‹ã¾ã§ã§ã™");
    return;
  }

  const rarity = document.getElementById("rarity").value;
  const links = [];

  for (let i = 1; i <= (rarity === "gold" ? 3 : 2); i++) {
    const type = document.getElementById(`link${i}type`).value;
    const level = Number(document.getElementById(`link${i}level`).value);
    links.push({ type, level });
  }

  modules.push({ id: moduleId++, rarity, links });
  renderModules();
}


/* ============================================================
   â–¼ 6. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º
   ============================================================ */

function renderModules() {
  const box = document.getElementById("moduleList");
  box.innerHTML = modules
    .map(m => `
      <div class="card">
        <b>${m.rarity === "gold" ? "é‡‘" : "ç´«"}</b><br>
        ${m.links.map(l => `${l.type} Lv${l.level}`).join("<br>")}
      </div>
    `)
    .join("");
}


/* ============================================================
   â–¼ 7. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
   ============================================================ */

let results = [];

function calculate() {
  results = [];

  const priority = document.getElementById("priority").value;
  const job = document.getElementById("jobSelect").value;
  const build = document.getElementById("buildSelect").value;
  const recommended = jobPresets[job].builds[build];

  // å…¨çµ„ã¿åˆã‚ã›
  for (let i = 0; i < modules.length; i++) {
    for (let j = i + 1; j < modules.length; j++) {
      for (let k = j + 1; k < modules.length; k++) {

        const arr = [modules[i], modules[j], modules[k]];

        // 16ä»¥ä¸Šã®ã‚³ã‚¢é›†è¨ˆ
        const map = {};
        arr.forEach(m => {
          m.links.forEach(l => {
            map[l.type] = (map[l.type] || 0) + l.level;
          });
        });

        const core16 = Object.entries(map)
          .filter(([_, v]) => v >= 16)
          .map(([k, v]) => ({ type: k, level: v }));

        if (core16.length === 0) continue;

        const recommendedCount = core16.filter(x => recommended.includes(x.type)).length;

        results.push({
          modules: arr,
          core16,
          coreCount: core16.length,
          recommendedCount
        });
      }
    }
  }

  renderResults();
}


/* ============================================================
   â–¼ 8. çµæœè¡¨ç¤ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ï¼‹ã‚½ãƒ¼ãƒˆï¼‹è‰²åˆ†ã‘ï¼‰
   ============================================================ */

function renderResults() {
  const box = document.getElementById("results");
  const filter = document.getElementById("recommendedFilter").value;
  const sortType = document.getElementById("sortType").value;

  const job = document.getElementById("jobSelect").value;
  const build = document.getElementById("buildSelect").value;
  const recommended = jobPresets[job].builds[build];

  let arr = results.slice();

  // â–¼ ãƒ•ã‚£ãƒ«ã‚¿
  arr = arr.filter(r => {
    if (filter === "1") return r.recommendedCount >= 1;
    if (filter === "2") return r.recommendedCount >= 2;
    if (filter === "all") return r.recommendedCount >= recommended.length;
    return true;
  });

  // â–¼ ã‚½ãƒ¼ãƒˆ
  if (sortType === "recommended") {
    arr.sort((a, b) => b.recommendedCount - a.recommendedCount);
  } else if (sortType === "count") {
    arr.sort((a, b) => b.coreCount - a.coreCount);
  } else {
    arr.sort((a, b) => {
      const an = a.core16.map(x => x.type).join("");
      const bn = b.core16.map(x => x.type).join("");
      return an.localeCompare(bn, "ja");
    });
  }

  // â–¼ è¡¨ç¤º
  box.innerHTML = arr
    .map(r => {
      const colorClass =
        r.coreCount >= 4 ? "gold" :
        r.coreCount === 3 ? "purple" :
        r.coreCount === 2 ? "blue" : "green";

      return `
        <div class="result-card ${colorClass}">
          <b>16ä»¥ä¸Šã®ã‚³ã‚¢ï¼š${r.coreCount}å€‹</b><br>
          <div class="core-grid">
            ${r.core16.map(c => `
              <div class="core-item">${c.type} Lv${c.level}</div>
            `).join("")}
          </div>
          <hr>
          <b>ãŠã™ã™ã‚ä¸€è‡´ï¼š${r.recommendedCount}å€‹</b>
        </div>
      `;
    })
    .join("");
}
