<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>スタレゾ 最適モジュール検索</title>

<style>
body{font-family:sans-serif;background:#111;color:#fff;padding:12px}
select,input,button{padding:8px;margin:4px 0;width:100%}
button{background:#00c853;border:none;color:#fff;font-size:16px;border-radius:6px}

.result-grid{display:flex;flex-wrap:wrap;gap:6px}
.result-card{width:31%;background:#1e1e1e;padding:8px;border-radius:6px;border-left:4px solid #00c853;cursor:pointer;font-size:12px}
.hidden{display:none}

.core-grid{display:flex;flex-wrap:wrap;gap:4px}
.core-item{width:48%;background:#222;padding:4px;border-radius:4px;font-size:11px}

.grid{display:flex;flex-wrap:wrap;gap:6px}
.grid .card{width:31%;background:#222;padding:8px;border-radius:6px;font-size:13px}

.edit-card{background:#333;padding:8px;border-radius:6px;margin-top:6px}

.link-set{background:#222;padding:10px;margin:6px 0;border-radius:6px}
.link-set select{width:60%;display:inline-block}
.link-set input{width:35%;display:inline-block;margin-left:4px}
</style>
</head>
<body>

<h2>最適モジュール検索</h2>

<h3>最優先パワーコア</h3>
<select id="priority"></select>

<h3>サブパワーコア（種類指定）</h3>
<select id="subCoreType">
  <option value="">指定なし</option>
</select>

<button onclick="calculate()">計算（全件表示）</button>

<hr>

<h3>サブパワーコア数で絞り込み</h3>
<select id="coreCountFilter" onchange="renderResults()">
  <option value="">指定なし</option>
  <option value="3">3個</option>
  <option value="2">2個</option>
  <option value="1">1個</option>
</select>

<h3>サブパワーコア種類で絞り込み</h3>
<select id="coreTypeFilter" onchange="renderResults()">
  <option value="">指定なし</option>
</select>

<h3>並び替え</h3>
<select id="sortType" onchange="renderResults()">
  <option value="best">最適順（Lv6数 → Lv5数 → 20に近い順）</option>
</select>

<h3>結果</h3>
<div id="results" class="result-grid"></div>

<hr>

<h3>モジュール登録</h3>

<select id="rarity">
<option value="gold">金（3リンク）</option>
<option value="purple">紫（2リンク）</option>
</select>

<div id="links"></div>

<button onclick="addModule()">追加</button>

<h3>登録済み</h3>
<div id="moduleList" class="grid"></div>
<p style="font-size:12px;color:#aaa">最大300個</p>
<script>
const linkTypes=[
"極・ダメージ増強","極・適応力","極・HP変動","極・HP凝縮",
"極・応急処置","極・絶境守護","極・HP吸収","極・幸運会心",
"集中・詠唱","集中・会心","集中・攻撃速度","集中・幸運",
"特攻ダメージ強化","精鋭打撃","筋力強化","知力強化",
"敏捷強化","特攻回復強化","マスタリー回復強化",
"魔法耐性","物理耐性"
];

let modules=JSON.parse(localStorage.getItem("modules"))||[];
let editingIndex=null;
let lastResults=[];

const prioritySelect=document.getElementById("priority");
const subCoreSelect=document.getElementById("subCoreType");

linkTypes.forEach(l=>{
 let o=document.createElement("option");
 o.text=l;
 prioritySelect.add(o);

 let o2=document.createElement("option");
 o2.text=l;
 subCoreSelect.add(o2);
});

function renderLinks(){
 const rarity=document.getElementById("rarity").value;
 const container=document.getElementById("links");
 container.innerHTML="";
 const count=rarity==="gold"?3:2;

 for(let i=0;i<count;i++){
   container.innerHTML+=`
     <div class="link-set">
       <select class="lname">
         ${linkTypes.map(l=>`<option>${l}</option>`).join("")}
       </select>
       <input type="number" class="lval" placeholder="値(1-10)" min="1" max="10">
     </div>
   `;
 }
}
renderLinks();
document.getElementById("rarity").onchange=renderLinks;

function save(){localStorage.setItem("modules",JSON.stringify(modules));}

function render(){
 const list=document.getElementById("moduleList");
 list.innerHTML="";

 modules.forEach((m,i)=>{
   if(editingIndex===i){
     list.innerHTML+=`
       <div class="card">
         <b>${i+1} 編集中</b>
         <div class="edit-card">
           ${m.links.map((l,idx)=>`
             <div class="link-set">
               <select class="edit-name" data-idx="${idx}">
                 ${linkTypes.map(t=>`<option ${t===l.name?"selected":""}>${t}</option>`).join("")}
               </select>
               <input type="number" class="edit-value" data-idx="${idx}" value="${l.value}" min="1" max="10">
             </div>
           `).join("")}
           <button onclick="saveEdit(${i})">保存</button>
           <button onclick="cancelEdit()">キャンセル</button>
         </div>
       </div>
     `;
   } else {
     list.innerHTML+=`
       <div class="card">
         <b>${i+1}:</b><br>
         ${m.links.map(l=>`${l.name}+${l.value}`).join(" / ")}
         <br>
         <button onclick="startEdit(${i})">編集</button>
         <button onclick="removeModule(${i})">削除</button>
       </div>`;
   }
 });
}

function startEdit(i){editingIndex=i;render();}
function cancelEdit(){editingIndex=null;render();}

function saveEdit(i){
 const names=document.querySelectorAll(".edit-name");
 const vals=document.querySelectorAll(".edit-value");

 let newLinks=[];
 for(let j=0;j<names.length;j++){
   let v=parseInt(vals[j].value);
   if(!v){alert("値を入力してください");return;}
   newLinks.push({name:names[j].value,value:v});
 }

 modules[i].links=newLinks;
 save();
 editingIndex=null;
 render();
}

function addModule(){
 if(modules.length>=300){alert("最大300個");return;}
 const names=document.querySelectorAll(".lname");
 const vals=document.querySelectorAll(".lval");
 let links=[];
 for(let i=0;i<names.length;i++){
   let v=parseInt(vals[i].value);
   if(!v){alert("値入力");return;}
   links.push({name:names[i].value,value:v});
 }
 modules.push({links});
 save();render();
 document.querySelectorAll(".lval").forEach(i=>i.value="");
}

function removeModule(i){
 modules.splice(i,1);save();render();
}
/* ============================
   ここから A方式（2＋2分割）高速化エンジン
   ============================ */

function calculate(){
  const resultsDiv=document.getElementById("results");
  resultsDiv.innerHTML="計算中…（高速化エンジン稼働）";

  const priority=prioritySelect.value;
  const subCore=subCoreSelect.value;

  // 2つの組を全部作る（約3万通り）
  let pairs=[];

  for(let i=0;i<modules.length-1;i++){
    for(let j=i+1;j<modules.length;j++){

      let totals={};
      modules[i].links.forEach(l=>{
        totals[l.name]=(totals[l.name]||0)+l.value;
      });
      modules[j].links.forEach(l=>{
        totals[l.name]=(totals[l.name]||0)+l.value;
      });

      // 2つの組の段階で優先パワーが弱すぎる場合は保存しない
      if(priority && (!totals[priority] || totals[priority] < 8)) continue;

      // サブパワー種類指定がある場合も同様
      if(subCore && (!totals[subCore] || totals[subCore] < 8)) continue;

      pairs.push({
        idx1:i,
        idx2:j,
        totals
      });
    }
  }

  // 4つの組を作る（pairA と pairB を合体）
  let best=[];

  for(let a=0;a<pairs.length-1;a++){
    for(let b=a+1;b<pairs.length;b++){

      // 同じモジュールを使っていたら無効
      if(
        pairs[a].idx1===pairs[b].idx1 ||
        pairs[a].idx1===pairs[b].idx2 ||
        pairs[a].idx2===pairs[b].idx1 ||
        pairs[a].idx2===pairs[b].idx2
      ) continue;

      // 合体した totals を作る
      let totals={};
      const addTotals=(obj)=>{
        Object.keys(obj).forEach(k=>{
          totals[k]=(totals[k]||0)+obj[k];
        });
      };
      addTotals(pairs[a].totals);
      addTotals(pairs[b].totals);

      // 優先パワーコア 16 未満は除外
      if(!totals[priority] || totals[priority] < 16) continue;

      // サブパワー種類指定がある場合
      if(subCore && (!totals[subCore] || totals[subCore] < 16)) continue;

      // 16以上のリンクを抽出
      let core16={};
      linkTypes.forEach(k=>{
        if((totals[k]||0)>=16) core16[k]=totals[k];
      });
      if(Object.keys(core16).length===0) continue;

      // Lv6 / Lv5 カウント
      let lv6Count=0;
      let lv5Count=0;
      Object.keys(totals).forEach(k=>{
        const v=totals[k];
        if(v>=20) lv6Count++;
        else if(v>=16) lv5Count++;
      });

      // 20 への距離
      let distanceSum=0;
      Object.keys(totals).forEach(k=>{
        if(totals[k]>=16) distanceSum+=Math.abs(20-totals[k]);
      });

      best.push({
        modules:[
          pairs[a].idx1,
          pairs[a].idx2,
          pairs[b].idx1,
          pairs[b].idx2
        ],
        priorityValue:totals[priority],
        core16,
        coreCount:Object.keys(core16).length,
        lv6Count,
        lv5Count,
        distanceSum
      });
    }
  }

  lastResults=best;
  updateCoreTypeFilter();
  renderResults();
}

/* ============================
   結果表示
   ============================ */

function updateCoreTypeFilter(){
 const sel=document.getElementById("coreTypeFilter");
 sel.innerHTML=`<option value="">指定なし</option>`;

 let set=new Set();
 lastResults.forEach(r=>{
   Object.keys(r.core16).forEach(k=>set.add(k));
 });

 [...set].sort((a,b)=>a.localeCompare(b,"ja")).forEach(k=>{
   sel.innerHTML+=`<option value="${k}">${k}</option>`;
 });
}

function renderResults(){
 const resultsDiv=document.getElementById("results");

 let arr=[...lastResults];

 const countFilter=document.getElementById("coreCountFilter").value;
 if(countFilter) arr=arr.filter(r=>r.coreCount==Number(countFilter));

 const typeFilter=document.getElementById("coreTypeFilter").value;
 if(typeFilter) arr=arr.filter(r=>Object.keys(r.core16).includes(typeFilter));

 arr.sort((a,b)=>{
   if(b.lv6Count!==a.lv6Count) return b.lv6Count-a.lv6Count;
   if(b.lv5Count!==a.lv5Count) return b.lv5Count-a.lv5Count;
   if(a.distanceSum!==b.distanceSum) return a.distanceSum-b.distanceSum;
   const A=Object.keys(a.core16).sort().join(",");
   const B=Object.keys(b.core16).sort().join(",");
   return A.localeCompare(B,"ja");
 });

 if(arr.length===0){
   resultsDiv.innerHTML="該当なし";
   return;
 }

 resultsDiv.innerHTML=arr.map((r,i)=>{
   let coreItems=Object.keys(r.core16).map(k=>
     `<div class="core-item">${k} ${r.core16[k]}</div>`
   ).join("");

   let moduleList=r.modules.map(idx=>
     `${idx+1}: ${modules[idx].links.map(l=>`${l.name}+${l.value}`).join(" / ")}`
   ).join("<br>---<br>");

   return `
   <div class="result-card" onclick="toggleDetail('d${i}')">
     <b>#${i+1}</b><br>
     優先：${prioritySelect.value} → ${r.priorityValue}<br>
     Lv6:${r.lv6Count} / Lv5:${r.lv5Count}<br>
     <b>サブパワーコア</b>
     <div class="core-grid">${coreItems}</div>

     <div id="d${i}" class="hidden" style="margin-top:6px;">
       <b>使用モジュール</b><br>
       ${moduleList}
     </div>
   </div>
   `;
 }).join("");
}

function toggleDetail(id){
 document.getElementById(id).classList.toggle("hidden");
}

render();
</script>

</body>
</html>
