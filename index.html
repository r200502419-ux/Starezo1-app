<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¹ã‚¿ãƒ¬ã‚¾ æœ€é©ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¤œç´¢</title>

<!-- OCRãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
body{font-family:sans-serif;background:#111;color:#fff;padding:12px}
select,input,button{padding:8px;margin:4px 0;width:100%}
button{background:#00c853;border:none;color:#fff;font-size:16px;border-radius:6px}

/* çµæœã®3åˆ—è¡¨ç¤º */
.result-grid{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.result-card{
  width:31%;
  background:#1e1e1e;
  padding:8px;
  border-radius:6px;
  border-left:4px solid #00c853;
  cursor:pointer;
  font-size:12px;
}
.hidden{display:none}

/* ã‚µãƒ–ãƒ‘ãƒ¯ãƒ¼ã‚³ã‚¢ã®2åˆ—è¡¨ç¤º */
.core-grid{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.core-item{
  width:48%;
  background:#222;
  padding:4px;
  border-radius:4px;
  font-size:11px;
}

/* ç™»éŒ²ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®3åˆ—è¡¨ç¤º */
.grid{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.grid .card{
  width:31%;
  background:#222;
  padding:8px;
  border-radius:6px;
  font-size:13px;
}

/* ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */
.edit-card{
  background:#333;
  padding:8px;
  border-radius:6px;
  margin-top:6px;
}

/* ãƒªãƒ³ã‚¯ã‚»ãƒƒãƒˆ */
.link-set{
  background:#222;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
}
.link-set select{
  width:60%;
  display:inline-block;
}
.link-set input{
  width:35%;
  display:inline-block;
  margin-left:4px;
}
</style>
</head>
<body>

<h2>æœ€å„ªå…ˆLv6 / Lv5 çµ„ã¿åˆã‚ã›æ¤œç´¢ãƒ„ãƒ¼ãƒ«</h2>

<h3>æœ€å„ªå…ˆãƒ‘ãƒ¯ãƒ¼ã‚³ã‚¢</h3>
<select id="priority"></select>

<button onclick="calculate()">è¨ˆç®—ï¼ˆå…¨ä»¶è¡¨ç¤ºï¼‰</button>

<hr>

<h3>ã‚µãƒ–ãƒ‘ãƒ¯ãƒ¼ã‚³ã‚¢æ•°ã§çµã‚Šè¾¼ã¿</h3>
<select id="coreCountFilter" onchange="renderResults()">
  <option value="">æŒ‡å®šãªã—</option>
  <option value="3">3å€‹</option>
  <option value="2">2å€‹</option>
  <option value="1">1å€‹</option>
</select>

<h3>ã‚µãƒ–ãƒ‘ãƒ¯ãƒ¼ã‚³ã‚¢æŒ‡å®š</h3>
<select id="coreTypeFilter" onchange="renderResults()">
  <option value="">æŒ‡å®šãªã—</option>
</select>

<h3>ä¸¦ã³æ›¿ãˆ</h3>
<select id="sortType" onchange="renderResults()">
  <option value="best">æœ€é©é †ï¼ˆLv6æ•° â†’ Lv5æ•° â†’ 20ã«è¿‘ã„é †ï¼‰</option>
</select>

<h3>çµæœ</h3>
<div id="results" class="result-grid"></div>

<hr>

<h3>ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²</h3>

<!-- â˜… ã‚¹ã‚¯ã‚·ãƒ§èª­ã¿å–ã‚Šãƒœã‚¿ãƒ³ -->
<button id="imgReadBtn">ğŸ“¸ ã‚¹ã‚¯ã‚·ãƒ§ã‹ã‚‰èª­ã¿å–ã‚‹</button>
<input type="file" id="imgInput" accept="image/*" multiple style="display:none;">
<p style="font-size:12px;color:#aaa">æœ€å¤§100æšã¾ã§é¸æŠå¯èƒ½</p>

<select id="rarity">
<option value="gold">é‡‘ï¼ˆ3ãƒªãƒ³ã‚¯ï¼‰</option>
<option value="purple">ç´«ï¼ˆ2ãƒªãƒ³ã‚¯ï¼‰</option>
</select>

<div id="links"></div>

<button onclick="addModule()">è¿½åŠ </button>

<h3>ç™»éŒ²æ¸ˆã¿</h3>
<div id="moduleList" class="grid"></div>
<p style="font-size:12px;color:#aaa">æœ€å¤§300å€‹</p>

<script>
// â–¼ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é †
const linkTypes = [
  "æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ¥µãƒ»é©å¿œåŠ›","æ¥µãƒ»HPå¤‰å‹•","æ¥µãƒ»HPå‡ç¸®",
  "æ¥µãƒ»å¿œæ€¥å‡¦ç½®","æ¥µãƒ»çµ¶å¢ƒå®ˆè­·","æ¥µãƒ»HPå¸å","æ¥µãƒ»å¹¸é‹ä¼šå¿ƒ",
  "é›†ä¸­ãƒ»è© å”±","é›†ä¸­ãƒ»ä¼šå¿ƒ","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","é›†ä¸­ãƒ»å¹¸é‹",
  "ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","ç­‹åŠ›å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–",
  "æ•æ·å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
  "é­”æ³•è€æ€§","ç‰©ç†è€æ€§"
];

let modules = JSON.parse(localStorage.getItem("modules"))||[];
let editingIndex = null;
let lastResults = [];

const prioritySelect=document.getElementById("priority");
linkTypes.forEach(l=>{
 let o=document.createElement("option");
 o.text=l;
 prioritySelect.add(o);
});

function renderLinks(){
 const rarity=document.getElementById("rarity").value;
 const container=document.getElementById("links");
 container.innerHTML="";
 const count=rarity==="gold"?3:2;

 for(let i=0;i<count;i++){
   container.innerHTML+=`
     <div class="link-set">
       <select class="lname">
         ${linkTypes.map(l=>`<option>${l}</option>`).join("")}
       </select>
       <input type="number" class="lval" placeholder="å€¤(1-10)" min="1" max="10">
     </div>
   `;
 }
}
renderLinks();
document.getElementById("rarity").onchange=renderLinks;

function save(){localStorage.setItem("modules",JSON.stringify(modules));}

function render(){
 const list=document.getElementById("moduleList");
 list.innerHTML="";

 modules.forEach((m,i)=>{
   if(editingIndex === i){
     list.innerHTML += `
       <div class="card">
         <b>${i+1} ç·¨é›†ä¸­</b>
         <div class="edit-card">
           ${m.links.map((l,idx)=>`
             <div class="link-set">
               <select class="edit-name" data-idx="${idx}">
                 ${linkTypes.map(t=>`<option ${t===l.name?"selected":""}>${t}</option>`).join("")}
               </select>
               <input type="number" class="edit-value" data-idx="${idx}" value="${l.value}" min="1" max="10">
             </div>
           `).join("")}
           <button onclick="saveEdit(${i})">ä¿å­˜</button>
           <button onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
         </div>
       </div>
     `;
   } else {
     list.innerHTML+=`
       <div class="card">
         <b>${i+1}:</b><br>
         ${m.links.map(l=>`${l.name}+${l.value}`).join(" / ")}
         <br>
         <button onclick="startEdit(${i})">ç·¨é›†</button>
         <button onclick="removeModule(${i})">å‰Šé™¤</button>
       </div>`;
   }
 });
}

function startEdit(i){
 editingIndex = i;
 render();
}

function cancelEdit(){
 editingIndex = null;
 render();
}

function saveEdit(i){
 const names=document.querySelectorAll(".edit-name");
 const vals=document.querySelectorAll(".edit-value");

 let newLinks=[];
 for(let j=0;j<names.length;j++){
   let v=parseInt(vals[j].value);
   if(!v){alert("å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
   newLinks.push({name:names[j].value,value:v});
 }

 modules[i].links = newLinks;
 save();
 editingIndex = null;
 render();
}

function addModule(){
 if(modules.length>=300){alert("æœ€å¤§300å€‹");return;}
 const names=document.querySelectorAll(".lname");
 const vals=document.querySelectorAll(".lval");
 let links=[];
 for(let i=0;i<names.length;i++){
   let v=parseInt(vals[i].value);
   if(!v){alert("å€¤å…¥åŠ›");return;}
   links.push({name:names[i].value,value:v});
 }
 modules.push({links});
 save(); render();
 document.querySelectorAll(".lval").forEach(i=>i.value="");
}

function removeModule(i){
 modules.splice(i,1); save(); render();
}

function calculate(){
 const resultsDiv=document.getElementById("results");
 resultsDiv.innerHTML="è¨ˆç®—ä¸­...";
 const priority=prioritySelect.value;
 let best=[];

 for(let a=0;a<modules.length-3;a++){
 for(let b=a+1;b<modules.length-2;b++){
 for(let c=b+1;c<modules.length-1;c++){
 for(let d=c+1;d<modules.length;d++){

   let totals={};
   [modules[a],modules[b],modules[c],modules[d]].forEach(m=>{
     m.links.forEach(l=>{
       totals[l.name]=(totals[l.name]||0)+l.value;
     });
   });

   if(!totals[priority] || totals[priority] < 16) continue;

   let core16 = {};
   linkTypes.forEach(k=>{
     if ((totals[k]||0) >= 16) {
       core16[k] = totals[k];
     }
   });

   if (Object.keys(core16).length === 0) continue;

   let lv6Count = 0;
   let lv5Count = 0;
   Object.keys(totals).forEach(k=>{
     const v = totals[k];
     if (v >= 20) lv6Count++;
     else if (v >= 16) lv5Count++;
   });

   let distanceSum = 0;
   Object.keys(totals).forEach(k=>{
     if (totals[k] >= 16) {
       distanceSum += Math.abs(20 - totals[k]);
     }
   });

   best.push({
     modules:[a,b,c,d],
     priorityValue:totals[priority],
     core16,
     coreCount: Object.keys(core16).length,
     lv6Count,
     lv5Count,
     distanceSum
   });

 }}}}

 lastResults = best;
 updateCoreTypeFilter();
 renderResults();
}

function updateCoreTypeFilter() {
  const sel = document.getElementById("coreTypeFilter");
  sel.innerHTML = `<option value="">æŒ‡å®šãªã—</option>`;

  let set = new Set();
  lastResults.forEach(r => {
    Object.keys(r.core16).forEach(k => set.add(k));
  });

  [...set].sort((a,b)=>a.localeCompare(b,"ja")).forEach(k=>{
    sel.innerHTML += `<option value="${k}">${k}</option>`;
  });
}

function renderResults(){
 const resultsDiv=document.getElementById("results");

 let arr=[...lastResults];

 const countFilter = document.getElementById("coreCountFilter").value;
 if (countFilter) {
   arr = arr.filter(r => r.coreCount == Number(countFilter));
 }

 const typeFilter = document.getElementById("coreTypeFilter").value;
 if (typeFilter) {
   arr = arr.filter(r => Object.keys(r.core16).includes(typeFilter));
 }

 arr.sort((a,b)=>{
   if (b.lv6Count !== a.lv6Count) return b.lv6Count - a.lv6Count;
   if (b.lv5Count !== a.lv5Count) return b.lv5Count - a.lv5Count;
   if (a.distanceSum !== b.distanceSum) return a.distanceSum - b.distanceSum;

   const A = Object.keys(a.core16).sort().join(",");
   const B = Object.keys(b.core16).sort().join(",");
   return A.localeCompare(B,"ja");
 });

 if(arr.length===0){
   resultsDiv.innerHTML="è©²å½“ãªã—";
   return;
 }

 resultsDiv.innerHTML = arr.map((r,i)=>{
   let coreItems = Object.keys(r.core16).map(k=>
     `<div class="core-item">${k} ${r.core16[k]}</div>`
   ).join("");

   let moduleList = r.modules.map(idx=>
     `${idx+1}: ${modules[idx].links.map(l=>`${l.name}+${l.value}`).join(" / ")}`
   ).join("<br>---<br>");

   return `
   <div class="result-card" onclick="toggleDetail('d${i}')">
     <b>#${i+1}</b><br>
     å„ªå…ˆï¼š${prioritySelect.value} â†’ ${r.priorityValue}<br>
     Lv6:${r.lv6Count} / Lv5:${r.lv5Count}<br>
     <b>ã‚µãƒ–ãƒ‘ãƒ¯ãƒ¼ã‚³ã‚¢</b>
     <div class="core-grid">${coreItems}</div>

     <div id="d${i}" class="hidden" style="margin-top:6px;">
       <b>ä½¿ç”¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</b><br>
       ${moduleList}
     </div>
   </div>
   `;
 }).join("");
}

function toggleDetail(id){
 document.getElementById(id).classList.toggle("hidden");
}

render();

// â–¼ é‡è¤‡åˆ¤å®šã‚­ãƒ¼
function makeKey(links){
  return links
    .slice()
    .sort((a,b)=>a.name.localeCompare(b.name,"ja"))
    .map(l => `${l.name}:${l.value}`)
    .join("|");
}

// â–¼ OCRèª­ã¿å–ã‚Šï¼ˆ3è¡Œæ§‹é€ å¯¾å¿œãƒ»æœ€çµ‚ç‰ˆï¼‰
async function readFromImage(file){
  const result = await Tesseract.recognize(file, 'jpn');
  let text = result.data.text;

  text = text
    .replace(/ï¼‹/g, "+")
    .replace(/ã€€/g, " ")
    .replace(/\s+/g, " ")
    .trim();

  let lines = text.split("\n").map(t=>t.trim()).filter(t=>t);
  let links = [];

  for(let i=0; i<lines.length; i++){
    let line = lines[i];

    // â‘  1è¡Œå½¢å¼
    let m1 = line.match(/(.+?)\s*\+?\s*(\d+)/);
    if(m1){
      let rawName = m1[1].trim();
      let value = parseInt(m1[2]);
      let name = rawName.replace(/ãƒ»/g,"").replace(/\s/g,"");
      let matched = linkTypes.find(t => t.replace(/ãƒ»/g,"").replace(/\s/g,"") === name);
      if(matched){
        links.push({name: matched, value});
        continue;
      }
    }

    // â‘¡ 3è¡Œå½¢å¼ï¼ˆåå‰ â†’ ã‚²ãƒ¼ã‚¸ â†’ æ•°å­—ï¼‰
    let rawName = line;
    let next1 = lines[i+1];
    let next2 = lines[i+2];

    let isGauge = next1 && /[â– â–¡â–®â–¯â–ˆ]/.test(next1);

    if(isGauge && next2 && /^\d+$/.test(next2)){
      let value = parseInt(next2);
      let name = rawName.replace(/ãƒ»/g,"").replace(/\s/g,"");
      let matched = linkTypes.find(t =>
        t.replace(/ãƒ»/g,"").replace(/\s/g,"") === name
      );
      if(matched){
        links.push({name: matched, value});
        i += 2;
      }
    }
  }

  if(links.length === 0){
    alert("èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚²ãƒ¼ãƒ ç”»é¢ã®3è¡Œæ§‹é€ ï¼‰");
    return;
  }

  let key = makeKey(links);
  let exists = modules.some(m => makeKey(m.links) === key);

  if(exists){
    alert("åŒã˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ï¼ˆé‡è¤‡ï¼‰");
    return;
  }

  modules.push({links});
  save();
  render();
  alert("1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²ã—ã¾ã—ãŸï¼");
}

// â–¼ ãƒœã‚¿ãƒ³ â†’ ç”»åƒé¸æŠ
document.getElementById("imgReadBtn").addEventListener("click", ()=>{
  document.getElementById("imgInput").click();
});

// â–¼ ç”»åƒé¸æŠ â†’ OCR
document.getElementById("imgInput").addEventListener("change", async (e)=>{
  const files = [...e.target.files].slice(0,100);
  for(let f of files){
    await readFromImage(f);
  }
});
</script>

</body>
</html>
