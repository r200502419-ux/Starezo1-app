<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>スタレゾ 最適モジュール検索</title>
<style>
body{font-family:sans-serif;background:#111;color:#fff;padding:12px}
select,input,button{padding:8px;margin:4px 0;width:100%}
button{background:#00c853;border:none;color:#fff;font-size:16px;border-radius:6px}

/* 結果の3列表示 */
.result-grid{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.result-card{
  width:31%;
  background:#1e1e1e;
  padding:8px;
  border-radius:6px;
  border-left:4px solid #00c853;
  cursor:pointer;
  font-size:12px;
}
.hidden{display:none}

/* サブパワーコアの2列表示 */
.core-grid{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.core-item{
<script>
// ▼ プルダウン順
const linkTypes = [
  "極・ダメージ増強","極・適応力","極・HP変動","極・HP凝縮",
  "極・応急処置","極・絶境守護","極・HP吸収","極・幸運会心",
  "集中・詠唱","集中・会心","集中・攻撃速度","集中・幸運",
  "特攻ダメージ強化","精鋭打撃","筋力強化","知力強化",
  "敏捷強化","特攻回復強化","マスタリー回復強化",
  "魔法耐性","物理耐性"
];

let modules = JSON.parse(localStorage.getItem("modules"))||[];
let editingIndex = null;
let lastResults = [];

const prioritySelect=document.getElementById("priority");
linkTypes.forEach(l=>{
 let o=document.createElement("option");
 o.text=l;
 prioritySelect.add(o);
});

function renderLinks(){
 const rarity=document.getElementById("rarity").value;
 const container=document.getElementById("links");
 container.innerHTML="";
 const count=rarity==="gold"?3:2;

 for(let i=0;i<count;i++){
   container.innerHTML+=`
     <div class="link-set">
       <select class="lname">
         ${linkTypes.map(l=>`<option>${l}</option>`).join("")}
       </select>
       <input type="number" class="lval" placeholder="値(1-10)" min="1" max="10">
     </div>
   `;
 }
}
renderLinks();
document.getElementById("rarity").onchange=renderLinks;

function save(){localStorage.setItem("modules",JSON.stringify(modules));}

function render(){
 const list=document.getElementById("moduleList");
 list.innerHTML="";

 modules.forEach((m,i)=>{
   if(editingIndex === i){
     list.innerHTML += `
       <div class="card">
         <b>${i+1} 編集中</b>
         <div class="edit-card">
           ${m.links.map((l,idx)=>`
             <div class="link-set">
               <select class="edit-name" data-idx="${idx}">
                 ${linkTypes.map(t=>`<option ${t===l.name?"selected":""}>${t}</option>`).join("")}
               </select>
               <input type="number" class="edit-value" data-idx="${idx}" value="${l.value}" min="1" max="10">
             </div>
           `).join("")}
           <button onclick="saveEdit(${i})">保存</button>
           <button onclick="cancelEdit()">キャンセル</button>
         </div>
       </div>
     `;
   } else {
     list.innerHTML+=`
       <div class="card">
         <b>${i+1}:</b><br>
         ${m.links.map(l=>`${l.name}+${l.value}`).join(" / ")}
         
function calculate(){
 const resultsDiv=document.getElementById("results");
 resultsDiv.innerHTML="計算中...";
 const priority=prioritySelect.value;
 let best=[];

 for(let a=0;a<modules.length-3;a++){
 for(let b=a+1;b<modules.length-2;b++){
 for(let c=b+1;c<modules.length-1;c++){
 for(let d=c+1;d<modules.length;d++){

   let totals={};
   [modules[a],modules[b],modules[c],modules[d]].forEach(m=>{
     m.links.forEach(l=>{
       totals[l.name]=(totals[l.name]||0)+l.value;
     });
   });

   // 優先コアは16以上でOK
   if(!totals[priority] || totals[priority] < 16) continue;

   // サブパワーコア（優先含む）
   let core16 = {};
   linkTypes.forEach(k=>{
     if ((totals[k]||0) >= 16) {
       core16[k] = totals[k];
     }
   });

   if (Object.keys(core16).length === 0) continue;

   // Lv6 / Lv5 カウント
   let lv6Count = 0;
   let lv5Count = 0;
   Object.keys(totals).forEach(k=>{
     const v = totals[k];
     if (v >= 20) lv6Count++;
     else if (v >= 16) lv5Count++;
   });

   // 20からの距離（最適度）
   let distanceSum = 0;
   Object.keys(totals).forEach(k=>{
     if (totals[k] >= 16) {
       distanceSum += Math.abs(20 - totals[k]);
     }
   });

   best.push({
     modules:[a,b,c,d],
     priorityValue:totals[priority],
     core16,
     coreCount: Object.keys(core16).length,
     lv6Count,
     lv5Count,
     distanceSum
   });

 }}}}

 lastResults = best;
 updateCoreTypeFilter();
 renderResults();
}

function updateCoreTypeFilter() {
  const sel = document.getElementById("coreTypeFilter");
  sel.innerHTML = `<option value="">指定なし</option>`;

  let set = new Set();
  lastResults.forEach(r => {
    Object.keys(r.core16).forEach(k => set.add(k));
  });

  [...set].sort((a,b)=>a.localeCompare(b,"ja")).forEach(k=>{
    sel.innerHTML += `<option value="${k}">${k}</option>`;
  });
}

function renderResults(){
 const resultsDiv=document.getElementById("results");

 let arr=[...lastResults];

 // ▼ サブパワーコア数フィルタ
 const countFilter = document.getElementById("coreCountFilter").value;
 if (countFilter) {
   arr = arr.filter(r => r.coreCount == Number(countFilter));
 }

 // ▼ サブパワーコア指定フィルタ
 const typeFilter = document.getElementById("coreTypeFilter").value;
 if (typeFilter) {
   arr = arr.filter(r => Object.keys(r.core16).includes(typeFilter));
 }

 // ▼ ソート（Lv6 → Lv5 → 20に近い順 → 名前順）
 arr.sort((a,b)=>{
   if (b.lv6Count !== a.lv6Count) return b.lv6Count - a.lv6Count;
   if (b.lv5Count !== a.lv5Count) return b.lv5Count - a.lv5Count;
   if (a.distanceSum !== b.distanceSum) return a.distanceSum - b.distanceSum;

   const A = Object.keys(a.core16).sort().join(",");
   const B = Object.keys(b.core16).sort().join(",");
   return A.localeCompare(B,"ja");
 });

 if(arr.length===0){
   resultsDiv.innerHTML="該当なし";
   return;
 }

 resultsDiv.innerHTML = arr.map((r,i)=>{
   let coreItems = Object.keys(r.core16).map(k=>
     `<div class="core-item">${k} ${r.core16[k]}</div>`
   ).join("");

   let moduleList = r.modules.map(idx=>
     `${idx+1}: ${modules[idx].links.map(l=>`${l.name}+${l.value}`).join(" / ")}`
   ).join("<br>---<br>");

   return `
   <div class="result-card" onclick="toggleDetail('d${i}')">
     <b>#${i+1}</b><br>
     優先：${prioritySelect.value} → ${r.priorityValue}<br>
     Lv6:${r.lv6Count} / Lv5:${r.lv5Count}<br>
     <b>サブパワーコア</b>
     <div class="core-grid">${coreItems}</div>

     <div id="d${i}" class="hidden" style="margin-top:6px;">
       <b>使用モジュール</b><br>
       ${moduleList}
     </div>
   </div>
   `;
 }).join("");
}

function toggleDetail(id){
 document.getElementById(id).classList.toggle("hidden");
}

render();
</script>
</body>
</html>
<!-- ▼ OCRライブラリ（Tesseract.js）読み込み -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<script>
// ▼ 重複判定用のキー生成
function makeKey(links){
  return links
    .slice()
    .sort((a,b)=>a.name.localeCompare(b.name,"ja"))
    .map(l => `${l.name}:${l.value}`)
    .join("|");
}

// ▼ OCRでスクショ読み取り → モジュール登録
async function readFromImage(file){
  const result = await Tesseract.recognize(file, 'jpn', {
    logger: m => console.log(m)
  });

  let text = result.data.text;
  console.log("OCR結果:", text);

  // ▼ 「名前 + 数値」を抽出
  let lines = text.split("\n").map(t=>t.trim()).filter(t=>t);
  let links = [];

  lines.forEach(line=>{
    // 例: "敏捷強化 +6"
    let m = line.match(/(.+?)\s*\+(\d+)/);
    if(m){
      let name = m[1].trim();
      let value = parseInt(m[2]);
      // ゲーム内のリンク名と一致するものだけ採用
      if(linkTypes.includes(name)){
        links.push({name,value});
      }
    }
  });

  if(links.length === 0){
    alert("リンクが読み取れませんでした");
    return;
  }

  // ▼ 重複チェック
  let key = makeKey(links);
  let exists = modules.some(m => makeKey(m.links) === key);

  if(exists){
    alert("同じモジュールが既に登録されています（重複）");
    return;
  }

  // ▼ 新規登録
  modules.push({links});
  save();
  render();
  alert("1モジュール登録しました！");
}

// ▼ 画像選択UIを作成
function setupImageInput(){
  const area = document.createElement("div");
  area.innerHTML = `
    <h3>スクショから読み取る</h3>
    <input type="file" id="imgInput" accept="image/*" multiple>
    <p style="font-size:12px;color:#aaa">最大100枚まで選択可能</p>
  `;
  document.body.appendChild(area);

  document.getElementById("imgInput").addEventListener("change", async (e)=>{
    const files = [...e.target.files].slice(0,100);
    for(let f of files){
      await readFromImage(f);
    }
  });
}

// ▼ ページ読み込み時に画像入力欄を追加
setupImageInput();
</script>
