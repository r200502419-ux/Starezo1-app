<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>スタレゾ 最適モジュール検索</title>
<style>
body{font-family:sans-serif;background:#111;color:#fff;padding:12px}
select,input,button{padding:8px;margin:4px 0;width:100%}
button{background:#00c853;border:none;color:#fff}
.card{background:#222;padding:8px;margin:6px 0}
.result{background:#1e1e1e;padding:10px;margin:6px 0;border-left:4px solid #00c853}
.small{font-size:12px;color:#aaa}
</style>
</head>
<body>

<h2>最優先Lv6 検索ツール</h2>

<h3>最優先パワーコア</h3>
<select id="priority"></select>

<hr>

<h3>モジュール登録</h3>

<select id="rarity">
<option value="gold">金（3リンク）</option>
<option value="purple">紫（2リンク）</option>
</select>

<div id="links"></div>

<button onclick="addModule()">追加</button>

<h3>登録済み</h3>
<div id="moduleList"></div>
<p class="small">最大100個</p>

<button onclick="calculate()">計算（上位50）</button>

<h3>結果</h3>
<div id="results"></div>

<script>
const linkTypes = [
"極・適応力","極・HP変動","筋力強化","知力強化",
"特攻回復強化","マスタリー回復強化","魔法耐性","物理耐性",
"集中・詠唱","集中・会心","極・HP凝縮","極・応急処置",
"極・絶境守護","極・HP吸収","極・幸運会心","敏捷強化",
"特攻ダメージ強化","精鋭打撃","集中・攻撃速度","集中・幸運","極・ダメージ増強"
];

let modules = JSON.parse(localStorage.getItem("modules"))||[];

const prioritySelect=document.getElementById("priority");
linkTypes.forEach(l=>{
 let o=document.createElement("option");
 o.text=l;
 prioritySelect.add(o);
});

function renderLinks(){
 const rarity=document.getElementById("rarity").value;
 const container=document.getElementById("links");
 container.innerHTML="";
 const count=rarity==="gold"?3:2;
 for(let i=0;i<count;i++){
   container.innerHTML+=`
   <select class="lname">
     ${linkTypes.map(l=>`<option>${l}</option>`).join("")}
   </select>
   <input type="number" class="lval" placeholder="値(1-20)" min="1" max="20">
   `;
 }
}
renderLinks();
document.getElementById("rarity").onchange=renderLinks;

function save(){localStorage.setItem("modules",JSON.stringify(modules));}

function render(){
 const list=document.getElementById("moduleList");
 list.innerHTML="";
 modules.forEach((m,i)=>{
  list.innerHTML+=`<div class="card">
   ${m.links.map(l=>`${l.name}+${l.value}`).join(" / ")}
   <button onclick="removeModule(${i})">削除</button>
  </div>`;
 });
}

function addModule(){
 if(modules.length>=100){alert("最大100個");return;}
 const names=document.querySelectorAll(".lname");
 const vals=document.querySelectorAll(".lval");
 let links=[];
 for(let i=0;i<names.length;i++){
   let v=parseInt(vals[i].value);
   if(!v){alert("値入力");return;}
   links.push({name:names[i].value,value:v});
 }
 modules.push({links});
 save(); render();
 document.querySelectorAll(".lval").forEach(i=>i.value="");
}

function removeModule(i){
 modules.splice(i,1); save(); render();
}

function getLv(sum){
 if(sum>=20) return 6;
 if(sum>=16) return 5;
 if(sum>=12) return 4;
 if(sum>=8) return 3;
 if(sum>=4) return 2;
 if(sum>=1) return 1;
 return 0;
}

function calculate(){
 const resultsDiv=document.getElementById("results");
 resultsDiv.innerHTML="計算中...";
 const priority=prioritySelect.value;
 let best=[];

 for(let a=0;a<modules.length-3;a++){
 for(let b=a+1;b<modules.length-2;b++){
 for(let c=b+1;c<modules.length-1;c++){
 for(let d=c+1;d<modules.length;d++){

   let totals={};
   [modules[a],modules[b],modules[c],modules[d]].forEach(m=>{
     m.links.forEach(l=>{
       totals[l.name]=(totals[l.name]||0)+l.value;
     });
   });

   if(!totals[priority]||totals[priority]<20) continue;

   let lv6count=0;
   let totalLv=0;
   for(let key in totals){
     let lv=getLv(totals[key]);
     totalLv+=lv;
     if(lv===6) lv6count++;
   }

   best.push({
     modules:[a,b,c,d],
     lv6count,
     priorityValue:totals[priority],
     totalLv
   });

 }}}
 }

 best.sort((x,y)=>
   y.lv6count-x.lv6count ||
   y.priorityValue-x.priorityValue ||
   y.totalLv-x.totalLv
 );

 const top=best.slice(0,50);

 if(top.length===0){resultsDiv.innerHTML="該当なし";return;}

 resultsDiv.innerHTML=top.map((r,i)=>`
 <div class="result">
 <b>#${i+1}</b> Lv6×${r.lv6count} / 総Lv ${r.totalLv}<br>
 ${r.modules.map(idx=>
   modules[idx].links.map(l=>`${l.name}+${l.value}`).join(" / ")
 ).join("<br>---<br>")}
 </div>
 `).join("");
}

render();
</script>
</body>
</html>
